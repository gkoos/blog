<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Breaking Your Own App (on Purpose) with Chaos Proxy</title>
  <meta name="description" content="How to use Chaos Proxy to simulate a slow network and test UI loading states in a Next.js app.">

  <!-- Facebook Meta Tags -->
  <meta property="og:url" content="https://gaborkoos.com">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Breaking Your Own App (on Purpose) with Chaos Proxy">
  <meta property="og:description" content="How to use Chaos Proxy to simulate a slow network and test UI loading states in a Next.js app.">
  <meta property="og:image" content="https://opengraph.b-cdn.net/production/images/74740c4e-d40d-49be-83fb-7170084dbda1.png?token=3Pxj4Ccc7Z93zXgN6-HhJM8U3lpcnqtTs8xNIPoUzF4&height=614&width=620&expires=33290472379">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="twitter:domain" content="gaborkoos.com">
  <meta property="twitter:url" content="https://gaborkoos.com">
  <meta name="twitter:title" content="Breaking Your Own App (on Purpose) with Chaos Proxy">
  <meta name="twitter:description" content="How to use Chaos Proxy to simulate a slow network and test UI loading states in a Next.js app.">
  <meta name="twitter:image" content="https://opengraph.b-cdn.net/production/images/74740c4e-d40d-49be-83fb-7170084dbda1.png?token=3Pxj4Ccc7Z93zXgN6-HhJM8U3lpcnqtTs8xNIPoUzF4&height=614&width=620&expires=33290472379">

  <!-- Meta Tags Generated via https://www.opengraph.xyz -->

  <!-- Analytics -->
  <script data-goatcounter="https://gkoos.goatcounter.com/count"  async src="//gc.zgo.at/count.js"></script>

  
  
  


  <link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico" />
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link rel="stylesheet" href="/assets/css/vendor/prism-tomorrow.css" />
  <link rel="stylesheet" href="/assets/css/fix-inline-code.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-['Inter',system-ui,sans-serif] antialiased leading-relaxed">
  <!-- Header/Navigation with Theme Switcher -->
  <header class="border-b border-gray-100 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 sticky top-0 z-10 transition-colors">
    <div class="max-w-4xl mx-auto px-6 py-6">
      <nav class="flex items-center justify-between">
        <div>
          <a href="/" class="text-base sm:text-xl font-semibold text-gray-900 dark:text-white hover:text-gray-700 dark:hover:text-gray-300 transition-colors mr-4 sm:mr-0">
            a developer blog
          </a>
        </div>
        <div class="flex items-center space-x-6">
          <a href="/" class="text-sm text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">Home</a>
          <a href="https://gaborkoos.com" class="text-sm text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">About</a>
          <a href="/categories" class="text-sm text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">Categories</a>
          <a href="/feed.xml" class="text-sm text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">RSS</a>
          <!-- Theme Switcher Button -->
          <button id="theme-toggle" aria-label="Toggle dark mode" class="ml-4 p-2 rounded focus:outline-none bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-200 transition-colors" style="display:inline-block;">
            <span id="theme-toggle-light" style="display:none">ðŸŒž</span>
            <span id="theme-toggle-dark" style="display:none">ðŸŒ™</span>
          </button>
        </div>
      </nav>
    </div>
  </header>


  <main class="max-w-4xl mx-auto px-6 py-12 transition-colors">
  <div class="prose prose-lg prose-gray dark:prose-invert max-w-none">
    
<article>
  <h1 class="text-3xl font-bold mb-4">Breaking Your Own App (on Purpose) with Chaos Proxy</h1>
  <div class="flex items-center space-x-4 text-sm text-gray-500 mb-6">
    <time datetime="2025-09-21T00:00:00.000Z">Sun Sep 21 2025</time>
    
    
      <span class="text-gray-300">â€¢</span>
      <div class="flex flex-wrap gap-2">
        
          <div class="flex items-center rounded-full bg-teal-500 text-white dark:bg-teal-400/10 dark:text-teal-300 px-3 py-1 text-xs font-medium leading-5">tutorials</div>
        
          <div class="flex items-center rounded-full bg-teal-500 text-white dark:bg-teal-400/10 dark:text-teal-300 px-3 py-1 text-xs font-medium leading-5">javascript</div>
        
          <div class="flex items-center rounded-full bg-teal-500 text-white dark:bg-teal-400/10 dark:text-teal-300 px-3 py-1 text-xs font-medium leading-5">typescript</div>
        
          <div class="flex items-center rounded-full bg-teal-500 text-white dark:bg-teal-400/10 dark:text-teal-300 px-3 py-1 text-xs font-medium leading-5">testing</div>
        
      </div>
    
  </div>
  <div class="prose dark:prose-invert max-w-none">
    <p>Chaos Engineering is a practice where you introduce controlled failures into your system to test its resilience and improve its reliability. It's a fun concept that can help you identify weaknesses in your application and infrastructure, but probably not something that you do every day - not everyone has the luxury of a Netflix-scale engineering team to manage a Netflix-scale infrastructure. But the concept is valid and useful even for small teams and projects.</p>
<p>In this article, we'll explore how to use the principles of Chaos Engineering to test UI loading states. We will use a simple tool called <a href="https://github.com/gkoos/chaos-proxy">Chaos Proxy</a> to implement and test a delayed loading indicator in a Network.js application.</p>
<h2 id="the-application" tabindex="-1"><a class="header-anchor" href="#the-application">The Application</a></h2>
<p>Imagine you're working for a company in the music streaming space. A small (but important) part of your application is a playlist feature that shows users their playlists and the songs within them.</p>
<p>The app is built with <a href="https://nextjs.org/">Next.js</a> and uses <a href="https://react-query.tanstack.com/">React Query</a> for data fetching. It has a few API routes to get playlists and songs, and two main pages: one for listing all playlists and another for showing the details of a selected playlist.</p>
<p>The code for the app is available on <a href="https://github.com/gkoos/article-chaos-proxy">GitHub</a>. Feel free to clone it and follow along:</p>
<pre class="language-sh"><code class="language-sh"><span class="token function">git</span> clone https://github.com/gkoos/article-chaos-proxy.git
<span class="token builtin class-name">cd</span> article-chaos-proxy
<span class="token function">npm</span> <span class="token function">install</span>
<span class="token function">npm</span> run dev
</code></pre>
<p>The app (well more like a stub) has the following features:</p>
<ul>
<li>
<p><strong>API Routes</strong>:</p>
<ul>
<li><code>GET /api/playlists</code> - Returns all playlists (id, name)</li>
<li><code>GET /api/playlists/:id</code> - Returns playlist details (id, name, description)</li>
<li><code>GET /api/playlists/:id/songs</code> - Returns songs in a playlist ([{order, songId}])</li>
<li><code>GET /api/song/:id</code> - Returns song details (id, artist, title)</li>
</ul>
</li>
<li>
<p><strong>Pages</strong>:</p>
<ul>
<li><code>/</code> - Lists all playlists, clickable to <code>/playlist/:playlistId</code></li>
<li><code>/playlist/:playlistId</code> - Shows playlist details and ordered songs</li>
</ul>
</li>
</ul>
<p>It uses React Query for data fetching. <a href="https://www.cypress.io/">Cypress</a> is set up for end-to-end testing and a few basic e2e tests are included. In our very sloppy setup, to run Cypress, make sure the app is running and then run:</p>
<pre class="language-sh"><code class="language-sh">npx cypress <span class="token function">open</span>
</code></pre>
<h2 id="the-problem" tabindex="-1"><a class="header-anchor" href="#the-problem">The Problem</a></h2>
<p>So you've built this app, and you're moderately happy with it. (I mean both the code quality and the DX are both meh, I'm sure you could do better, but for the sake of this article, let's say it's good enough.) You're about to grab a mocha latte, or a plant based cappuccino, when your manager comes to you and says:</p>
<blockquote>
<p>&quot;Hey, I got a great idea! Let's add a loading indicator to the playlist page. You know, like a spinner or something. But not always, only when the network is slow. Like, after 2 seconds or so. And while the data is loading, we should show a skeleton screen. You know, those grey boxes that look like the content but aren't. It'll be super cool and modern! Can you do that?&quot;</p>
</blockquote>
<p>Well, sure, you're an engineer. You can do that. But how do you test it? How do you simulate a slow network? You could use the browser's dev tools to throttle the network, but that's manual and tedious. You could use a library like <a href="https://mswjs.io/">msw</a> to mock the API responses, but that's a bit overkill for this simple app. You could even modify the API routes to introduce artificial delays, but that would be messy and not very elegant. Or use something like <a href="https://github.com/Shopify/toxiproxy">toxiproxy</a> to simulate network conditions, but that's also a bit heavy for this use case.</p>
<p>Essentially, your problem is two-fold: you have to simulate a slow network for both development and testing (and here doesn't even matter which one you do first, this is not a TDD-focused article). For testing, you want to be able to run your tests in CI/CD pipelines, where you can't rely on manual network throttling. You could mock the API calls and use fake timers, but that gets you to a point where your tests are more complex than your code and not even testing the real behavior of the app. For development, you want to be able to see the loading indicator in action without having to change your code or the API routes.</p>
<h2 id="the-solution%3A-chaos-proxy" tabindex="-1"><a class="header-anchor" href="#the-solution%3A-chaos-proxy">The Solution: Chaos Proxy</a></h2>
<p>Between ridiculously complex chaos engineering tools (like <a href="https://www.gremlin.com/">Gremlin</a> and <a href="https://github.com/Netflix/chaosmonkey">Chaos Monkey</a>) and convoluted, overengineered testing techniques, you want something lightweight and easy that covers both your development and testing needs.</p>
<p>That's where <a href="https://github.com/gkoos/chaos-proxy">Chaos Proxy</a> comes in. It's a simple reverse proxy that adds latency, drops requests, and simulates other network conditions. As a chaos engineering tool, it's barely a child's toy, but for this particular use case, it's perfect. It can be used to simulate a slow network for both development and testing, without modifying the app or the API routes.</p>
<h2 id="implementing-the-skeleton-and-the-loading-indicator" tabindex="-1"><a class="header-anchor" href="#implementing-the-skeleton-and-the-loading-indicator">Implementing the Skeleton and the Loading Indicator</a></h2>
<p>This is where some of you raise their eyebrows and say &quot;Wait, shouldn't we start with the tests first?&quot; Sure, you can do that. In fact, everything in this article stays valid if you do TDD. But for the sake of simplicity, let's just quickly implement the feature first and then test it.</p>
<p>Before you roll up your sleeves and start coding, let's see what your manager actually wants:</p>
<ul>
<li>A skeleton screen that shows up while the data is loading.</li>
<li>A loading indicator that shows up after 2 seconds of waiting for the API response.</li>
</ul>
<h3 id="the-skeleton-screen" tabindex="-1"><a class="header-anchor" href="#the-skeleton-screen">The Skeleton Screen</a></h3>
<p>You decide to start with the skeleton screen. It's usually implemented as a set of grey boxes that mimic the layout of the content. You can use a library like <a href="https://www.npmjs.com/package/react-loading-skeleton">react-loading-skeleton</a> to easily create skeleton screens.</p>
<p>You install the library:</p>
<pre class="language-sh"><code class="language-sh"><span class="token function">npm</span> <span class="token function">install</span> react-loading-skeleton
</code></pre>
<p>And then you modify the playlist page to show the skeleton screen while the data is loading:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// pages/playlist/[playlistId].js</span>
<span class="token keyword">import</span> Skeleton <span class="token keyword">from</span> <span class="token string">'react-loading-skeleton'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'react-loading-skeleton/dist/skeleton.css'</span><span class="token punctuation">;</span>

<span class="token operator">...</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>loadingPlaylist <span class="token operator">||</span> loadingSongs <span class="token operator">||</span> songQueries<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">q</span> <span class="token operator">=></span> q<span class="token punctuation">.</span>isLoading<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"max-w-xl mx-auto py-12 px-4"</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>Skeleton width<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">120</span><span class="token punctuation">}</span> height<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">24</span><span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token string">"mb-2"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>Skeleton width<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">220</span><span class="token punctuation">}</span> height<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token string">"mb-8"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>Skeleton width<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">100</span><span class="token punctuation">}</span> height<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">20</span><span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token string">"mb-4"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>ol className<span class="token operator">=</span><span class="token string">"space-y-2"</span><span class="token operator">></span>
          <span class="token punctuation">{</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token punctuation">{</span>i<span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token string">"bg-white rounded shadow p-4 border border-gray-200"</span><span class="token operator">></span>
              <span class="token operator">&lt;</span>Skeleton width<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">180</span><span class="token punctuation">}</span> height<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">16</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>
          <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ol<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token operator">...</span>
</code></pre>
<p>The full code for this chapter is available on the <code>improve-playlist-ui</code> branch:</p>
<pre class="language-sh"><code class="language-sh"><span class="token function">git</span> checkout improve-playlist-ui
</code></pre>
<p>If you run the app now, you'll see the skeleton screen while the data is loading. But since your network is fast, it loads almost instantly, and you don't get to see the skeleton screen for more than a split second. Also, note that react-query has a built-in caching mechanism, so if you navigate away and back to the playlist page, it will show the cached data immediately without showing the skeleton screen again (until you refresh the page or restart the app).</p>
<h3 id="setting-up-chaos-proxy" tabindex="-1"><a class="header-anchor" href="#setting-up-chaos-proxy">Setting Up Chaos Proxy</a></h3>
<p>So far so good, the skeleton screen seems to be working as expected. But for the loading indicator, even if your implementation is correct, you won't be able to see it in action without a slow network.</p>
<p>This is the right time to set up Chaos Proxy and simulate a slow network. First, install it as a dev dependency:</p>
<pre class="language-sh"><code class="language-sh"><span class="token function">npm</span> <span class="token function">install</span> --save-dev chaos-proxy
</code></pre>
<p>Then create a <code>chaos.yaml</code> file in the root of your project with the following content:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">8080</span>
<span class="token literal-property property">target</span><span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span>

<span class="token literal-property property">routes</span><span class="token operator">:</span>
  <span class="token operator">/</span>api<span class="token operator">:</span>
    <span class="token operator">-</span> latency<span class="token operator">:</span>
        <span class="token literal-property property">ms</span><span class="token operator">:</span> <span class="token number">2000</span>
    <span class="token operator">-</span> cors<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<p>This configuration tells Chaos Proxy to listen on port 8080 and forward requests to your Next.js app running on port 3000. It also adds a latency of 2000 milliseconds (2 seconds) to all <code>/api/*</code>requests. Last but not least, it enables CORS for the API endpoints, which is important because your app will be making requests to a different origin (localhost:8080 instead of localhost:3000)!</p>
<p>Now you can start Chaos Proxy in a separate terminal window:</p>
<pre class="language-sh"><code class="language-sh">npx chaos-proxy
</code></pre>
<p>With Chaos Proxy running, you can now access your app through the proxy by navigating to <code>http://localhost:8080</code> in your browser. This way, all requests to your app will go through Chaos Proxy and will have the added latency.</p>
<p>Make sure the app is running (<code>npm run dev</code>), then try to curl the playlists API through the proxy to see the delay in action:</p>
<pre class="language-sh"><code class="language-sh"><span class="token function">curl</span> http://localhost:8080/api/playlists
</code></pre>
<p>You should see that the response takes about 2 seconds to arrive.</p>
<p>Now you want to make sure your app uses the proxy for API requests. Currently, the app is configured to read the base API URL from an environment variable called <code>NEXT_PUBLIC_BASE_API_URL</code>. You can set this variable to point to the proxy URL when running the app.</p>
<pre class="language-sh"><code class="language-sh"><span class="token assign-left variable">NEXT_PUBLIC_BASE_API_URL</span><span class="token operator">=</span>http://localhost:8080/api <span class="token function">npm</span> run dev
</code></pre>
<p>And now, if you navigate to <code>http://localhost:3000</code> in your browser, you should see the app working through the proxy. When you go to a playlist page, you should see the skeleton screen for 2 seconds before the data loads.</p>
<h3 id="the-loading-indicator" tabindex="-1"><a class="header-anchor" href="#the-loading-indicator">The Loading Indicator</a></h3>
<p>Now that you have the skeleton screen working and the slow network simulation set up, you can implement the loading indicator. You decide to use a simple text-based indicator that says &quot;Retrieving data...&quot; for simplicity. You can bet your manager will want to change it later.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// pages/playlist/[playlistId].js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useQuery<span class="token punctuation">,</span> useQueries <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@tanstack/react-query"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"next/router"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Skeleton <span class="token keyword">from</span> <span class="token string">"react-loading-skeleton"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"react-loading-skeleton/dist/skeleton.css"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">BASE_API_URL</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NEXT_PUBLIC_BASE_API_URL</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">fetchPlaylist</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">BASE_API_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/playlists/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fetchPlaylistSongs</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">BASE_API_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/playlists/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/songs</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">fetchSong</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">BASE_API_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/songs/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">PlaylistPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> playlistId <span class="token punctuation">}</span> <span class="token operator">=</span> router<span class="token punctuation">.</span>query<span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> playlist<span class="token punctuation">,</span> <span class="token literal-property property">isLoading</span><span class="token operator">:</span> loadingPlaylist <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">queryKey</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"playlist"</span><span class="token punctuation">,</span> playlistId<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function-variable function">queryFn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">fetchPlaylist</span><span class="token punctuation">(</span>playlistId<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">enabled</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>playlistId<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> songOrders<span class="token punctuation">,</span> <span class="token literal-property property">isLoading</span><span class="token operator">:</span> loadingSongs <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">queryKey</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"playlistSongs"</span><span class="token punctuation">,</span> playlistId<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function-variable function">queryFn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">fetchPlaylistSongs</span><span class="token punctuation">(</span>playlistId<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">enabled</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>playlistId<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> songQueries <span class="token operator">=</span> <span class="token function">useQueries</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">queries</span><span class="token operator">:</span> <span class="token punctuation">(</span>songOrders <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> songId <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">queryKey</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"song"</span><span class="token punctuation">,</span> songId<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function-variable function">queryFn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">fetchSong</span><span class="token punctuation">(</span>songId<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">enabled</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>songId<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Delayed loading indicator state</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>showDelayedIndicator<span class="token punctuation">,</span> setShowDelayedIndicator<span class="token punctuation">]</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> anySongLoading <span class="token operator">=</span> songQueries<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">q</span><span class="token punctuation">)</span> <span class="token operator">=></span> q<span class="token punctuation">.</span>isLoading<span class="token punctuation">)</span><span class="token punctuation">;</span>
  React<span class="token punctuation">.</span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> timer<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loadingPlaylist <span class="token operator">||</span> loadingSongs <span class="token operator">||</span> anySongLoading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setShowDelayedIndicator</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">setShowDelayedIndicator</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>loadingPlaylist<span class="token punctuation">,</span> loadingSongs<span class="token punctuation">,</span> anySongLoading<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>loadingPlaylist <span class="token operator">||</span> loadingSongs <span class="token operator">||</span> anySongLoading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"max-w-xl mx-auto py-12 px-4"</span><span class="token operator">></span>
        <span class="token punctuation">{</span>showDelayedIndicator <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
          <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"mb-4 text-center text-blue-500 animate-pulse"</span><span class="token operator">></span>
            Retrieving data<span class="token operator">...</span>
          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>Skeleton width<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">120</span><span class="token punctuation">}</span> height<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">24</span><span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token string">"mb-2"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>Skeleton width<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">220</span><span class="token punctuation">}</span> height<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token string">"mb-8"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>Skeleton width<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">100</span><span class="token punctuation">}</span> height<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">20</span><span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token string">"mb-4"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>ol className<span class="token operator">=</span><span class="token string">"space-y-2"</span><span class="token operator">></span>
          <span class="token punctuation">{</span>Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>li
              key<span class="token operator">=</span><span class="token punctuation">{</span>i<span class="token punctuation">}</span>
              className<span class="token operator">=</span><span class="token string">"bg-white rounded shadow p-4 border border-gray-200"</span><span class="token operator">></span>
              <span class="token operator">&lt;</span>Skeleton width<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">180</span><span class="token punctuation">}</span> height<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">16</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>
          <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ol<span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>playlist<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"flex items-center justify-center h-screen text-xl"</span><span class="token operator">></span>
        Playlist not found
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"max-w-xl mx-auto py-12 px-4"</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>a
        href<span class="token operator">=</span><span class="token string">"/"</span>
        className<span class="token operator">=</span><span class="token string">"text-blue-600 hover:text-blue-800 mb-6 inline-block"</span><span class="token operator">></span>
        <span class="token operator">&amp;</span>larr<span class="token punctuation">;</span> Back to playlists
      <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span>
      <span class="token operator">&lt;</span>h1 className<span class="token operator">=</span><span class="token string">"text-3xl font-bold mb-2"</span><span class="token operator">></span><span class="token punctuation">{</span>playlist<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&lt;</span>p className<span class="token operator">=</span><span class="token string">"mb-8 text-gray-600"</span><span class="token operator">></span><span class="token punctuation">{</span>playlist<span class="token punctuation">.</span>description<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&lt;</span>h2 className<span class="token operator">=</span><span class="token string">"text-xl font-semibold mb-4"</span><span class="token operator">></span>Songs<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">></span>
      <span class="token operator">&lt;</span>ol className<span class="token operator">=</span><span class="token string">"space-y-2"</span><span class="token operator">></span>
        <span class="token punctuation">{</span>songQueries<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">q<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
          <span class="token operator">&lt;</span>li
            key<span class="token operator">=</span><span class="token punctuation">{</span>i<span class="token punctuation">}</span>
            className<span class="token operator">=</span><span class="token string">"bg-white rounded shadow p-4 border border-gray-200"</span><span class="token operator">></span>
            <span class="token punctuation">{</span>q<span class="token punctuation">.</span>isLoading <span class="token operator">?</span> <span class="token punctuation">(</span>
              <span class="token string">""</span>
            <span class="token punctuation">)</span> <span class="token operator">:</span> q<span class="token punctuation">.</span>data <span class="token operator">?</span> <span class="token punctuation">(</span>
              <span class="token operator">&lt;</span><span class="token operator">></span>
                <span class="token operator">&lt;</span>span className<span class="token operator">=</span><span class="token string">"font-medium"</span><span class="token operator">></span><span class="token punctuation">{</span>q<span class="token punctuation">.</span>data<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span> by<span class="token punctuation">{</span><span class="token string">" "</span><span class="token punctuation">}</span>
                <span class="token operator">&lt;</span>span className<span class="token operator">=</span><span class="token string">"text-gray-500"</span><span class="token operator">></span><span class="token punctuation">{</span>q<span class="token punctuation">.</span>data<span class="token punctuation">.</span>artist<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>
              <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">></span>
            <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>
              <span class="token string">"Not found"</span>
            <span class="token punctuation">)</span><span class="token punctuation">}</span>
          <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>ol<span class="token operator">></span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Remember, the file is in the repo.</p>
<p>And that's it! You now have a skeleton screen that shows up immediately while the data is loading, and a loading indicator that shows up after 2 seconds if the data is still loading. You can see both in action by running the app through Chaos Proxy. The latency injected by Chaos Proxy will ensure that the loading indicator appears after two seconds.</p>
<h2 id="testing-with-cypress" tabindex="-1"><a class="header-anchor" href="#testing-with-cypress">Testing with Cypress</a></h2>
<p>Now that you have the feature implemented and working, it's time to test it (well, maybe you should have done that first, but let's not split hairs). You can use Cypress to write end-to-end tests for the playlist page, including the loading states.</p>
<p>The code for the tests is available on the <code>adding-tests</code> branch. Make sure to check it out:</p>
<pre class="language-sh"><code class="language-sh"><span class="token function">git</span> checkout adding-tests
</code></pre>
<p>One way to test both features is to write a test that navigates to a playlist page and checks for the presence of the skeleton screen and the loading indicator. Here's an example:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// cypress/e2e/playlist.cy.js</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Playlist page loading states'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'shows skeleton and delayed loading indicator'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    cy<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token string">'/playlist/1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Skeleton should be visible immediately</span>
    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'.react-loading-skeleton'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token string">'exist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Delayed loading indicator should appear after ~2s</span>
    cy<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">'Retrieving data...'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token string">'not.exist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cy<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">2100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Wait slightly longer than proxy latency</span>
    cy<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">'Retrieving data...'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token string">'exist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// After data loads, both skeleton and indicator disappear</span>
    cy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'.react-loading-skeleton'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token number">5000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token string">'not.exist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cy<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">'Retrieving data...'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">should</span><span class="token punctuation">(</span><span class="token string">'not.exist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>To run the end to end tests, you have to make sure both the app and Chaos Proxy are running. Build the app with <code>npm run build</code> and then create a new file called <code>start-next-chaos.js</code> in the root of your project with the following content:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// start-next-chaos.js</span>
<span class="token comment">// Programmatically start Next.js and Chaos Proxy in one process (no child processes)</span>
<span class="token keyword">const</span> next <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> startServer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chaos-proxy/dist/index.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">NEXT_PORT</span> <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CHAOS_PORT</span> <span class="token operator">=</span> <span class="token number">8080</span><span class="token punctuation">;</span>


<span class="token comment">// Set env var for Next.js to use the proxy</span>
process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NEXT_PUBLIC_BASE_API_URL</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">CHAOS_PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token comment">// Start Next.js (production mode)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">dev</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token constant">NEXT_PORT</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> handle <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">getRequestHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">NEXT_PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Failed to start Next.js:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Next.js ready on http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">NEXT_PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Start Chaos Proxy programmatically</span>
      <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token constant">CHAOS_PORT</span><span class="token punctuation">,</span>
        <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">NEXT_PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">global</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span> <span class="token literal-property property">latency</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">ms</span><span class="token operator">:</span> <span class="token number">2000</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token literal-property property">cors</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">verbose</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Chaos Proxy ready on http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">CHAOS_PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Keep the process alive</span>
      <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error preparing Next.js app:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Build the app with with <code>BASE_API_URL</code> pointing to the proxy:</p>
<pre class="language-sh"><code class="language-sh"><span class="token assign-left variable">NEXT_PUBLIC_BASE_API_URL</span><span class="token operator">=</span>http://localhost:8080/api <span class="token function">npm</span> run build
</code></pre>
<p>Then run both the app and Chaos Proxy:</p>
<pre class="language-sh"><code class="language-sh"><span class="token function">node</span> start-next-chaos.js
</code></pre>
<p>And then in another terminal, you can finally run the tests with the following command:</p>
<pre class="language-sh"><code class="language-sh">npx cypress run
</code></pre>
<p>And there you have it! The tests should pass, confirming that both the skeleton screen and the delayed loading indicator work as expected.</p>
<p>Now this setup is more than messy. In a real-world scenarion you'd probably containerize everything or for the very least use something like <code>concurrently</code> to run both processes in parallel. But my aim was only to show how you can run <code>chaos-proxy</code> both from the command line and programmatically from Node.js (in <code>start-next-chaos.js</code>).</p>
<h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion">Conclusion</a></h2>
<p>Of course, you can use Chaos Proxy as a lightweight chaos engineering tool to test other failure scenarios, like dropped requests or random errors. You can also use it to simulate different network conditions, like high latency or low bandwidth. But where it really can be useful is simpler use cases like this one, where you just want deterministic end-to-end tests and a better development experience without the overhead of complex tools or convoluted testing techniques.</p>

  </div>
</article>

  </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-gray-100 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 mt-20 transition-colors">
    <div class="max-w-4xl mx-auto px-6 py-12">
      <div class="text-center text-sm text-gray-600 dark:text-gray-300">
        <p>&copy; <span id="footer-year"></span> Gabor Koos</p>
      </div>
    </div>
  </footer>
  <!-- Theme Switcher Script -->
  <script>
    // Footer year
    document.getElementById('footer-year').textContent = new Date().getFullYear();
    // Theme switcher logic
    const root = document.documentElement;
    const themeToggle = document.getElementById('theme-toggle');
    const lightIcon = document.getElementById('theme-toggle-light');
    const darkIcon = document.getElementById('theme-toggle-dark');
    function setTheme(mode) {
      if (mode === 'dark') {
        root.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        darkIcon.style.display = 'none';
        lightIcon.style.display = '';
      } else {
        root.classList.remove('dark');
        localStorage.setItem('theme', 'light');
        darkIcon.style.display = '';
        lightIcon.style.display = 'none';
      }
    }
    // Initial theme
    const userTheme = localStorage.getItem('theme');
    const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (userTheme === 'dark' || (!userTheme && systemDark)) {
      setTheme('dark');
    } else {
      setTheme('light');
    }
    // Button is always visible; only icons are toggled
    themeToggle.addEventListener('click', () => {
    if (root.classList.contains('dark')) {
      setTheme('light');
    } else {
      setTheme('dark');
    }
    });
  </script>
</body>

<script>
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('pre code').forEach(function (codeBlock) {
    var pre = codeBlock.parentNode;
    pre.style.position = 'relative';
    pre.style.overflow = 'auto';

    var button = document.createElement('button');
    button.className = 'copy-btn';
    button.type = 'button';
    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
    button.style = 'position:absolute;top:0.2em;right:0.2em;padding:0.05em 0.05em;width:1.2em;height:1.2em;display:flex;align-items:center;justify-content:center;background:#eee;border-radius:0.2em;border:none;cursor:pointer;z-index:1;opacity:0.7;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:opacity 0.2s;pointer-events:auto;';
    button.onmouseenter = function() { button.style.opacity = '1'; };
    button.onmouseleave = function() { button.style.opacity = '0.7'; };
    pre.appendChild(button);
    button.addEventListener('click', function () {
      navigator.clipboard.writeText(codeBlock.innerText);
      var original = button.innerHTML;
      button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
      setTimeout(function () {
        button.innerHTML = original;
      }, 1200);
    });
  });
});
</script>

</body>
</html>
